<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MarchÃ© en direct â€¢ MMM V10.3</title>
  <link rel="stylesheet" href="/mmm.css">
</head>

<body>
  <div class="header">ðŸ“ˆ MarchÃ© en direct</div>

  <div class="grid">
    <div class="card"><b>Status:</b> prÃªt Ã  recevoir les flux. (V10.3 API)</div>
    <div class="card">
      <div class="small">Exemple de test API :</div>
      <a class="btn" href="/api/hello" target="_blank">Appeler /api/hello</a>
    </div>
  </div>

  <!-- Zone debug visible (tu pourras lâ€™enlever aprÃ¨s) -->
  <div id="debug" style="padding:8px;font-family:monospace;"></div>

  <!-- Ici on injecte les cards -->
  <div id="market-container" class="grid" style="margin-top:12px;"></div>

  <script type="module">
    const debug = (msg) => {
      document.getElementById("debug").innerHTML += msg + "<br/>";
    };

    async function main() {
      try {
        debug("ðŸ”„ Chargement module getBestImageâ€¦");

        const mod = await import("/getBestImage.js");
        const { getBestImage } = mod;

        debug("âœ… Module chargÃ©.");

        // âœ… 1) Charger les vrais flux marchÃ©
        // âš ï¸ Remplace /api/market par TA route rÃ©elle si diffÃ©rente
        debug("ðŸ“¡ RÃ©cupÃ©ration des flux marchÃ©â€¦");
        const data = await fetch("/api/market").then(r => r.json());

        // ðŸ” Debug pour voir la vraie structure
        debug("ðŸ§¾ RÃ©ponse brute: " + JSON.stringify(data).slice(0, 300) + "...");

        // âœ… 2) Normalisation robuste pour garantir un tableau
        let items = [];

        if (Array.isArray(data)) {
          items = data;
        } else if (Array.isArray(data.items)) {
          items = data.items;
        } else if (Array.isArray(data.results)) {
          items = data.results;
        } else if (Array.isArray(data.articles)) {
          items = data.articles;
        } else if (data.items && typeof data.items === "object") {
          // si items est un objet {0:{...},1:{...}}
          items = Object.values(data.items);
        } else if (data.data && Array.isArray(data.data)) {
          items = data.data;
        }

        // âœ… SÃ©curitÃ© finale
        if (!Array.isArray(items)) items = [];

        if (items.length === 0) {
          debug("âš ï¸ Aucun item trouvÃ© dans les flux (aprÃ¨s normalisation).");
          return; // stop pour Ã©viter map sur vide / objet
        }

        debug(`âœ… ${items.length} item(s) reÃ§us.`);

        // âœ… 3) Render
        await renderMarket(items, getBestImage);
        debug("ðŸŽ‰ Cards affichÃ©es.");

      } catch (e) {
        debug("âŒ Erreur: " + e.message);
      }
    }

    async function renderMarket(items, getBestImage) {
      const container = document.getElementById("market-container");
      container.innerHTML = "";

      // ðŸ”¥ ParallÃ©lisation pour aller plus vite
      const results = await Promise.all(
        items.map(async (item) => {
          const q = item.title || item.name || item.model || "OpportunitÃ©";
          const type = item.type || "product";
          const url = item.url || item.link || null;

          const img = await getBestImage({ q, type, url });
          return { item, img, q, type };
        })
      );

      for (const { item, img, q, type } of results) {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img
            src="${img.thumbUrl || img.imageUrl || "/placeholder.png"}"
            alt="${q}"
            style="width:100%;height:160px;object-fit:cover;border-radius:8px;margin-bottom:8px;"
          />
          <b>${q}</b><br/>
          <small>${type}</small>
          ${img.source === "ai-fallback" ? "<div class='small'>Illustration IA</div>" : ""}
        `;

        container.appendChild(card);
      }
    }

    main();
  </script>
</body>
</html>
