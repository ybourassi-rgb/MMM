<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>March√© en direct ‚Ä¢ MMM V10.3</title>
  <link rel="stylesheet" href="/mmm.css">
</head>

<body>
  <div class="header">üìà March√© en direct</div>

  <div class="grid">
    <div class="card"><b>Status:</b> pr√™t √† recevoir les flux. (V10.3 API)</div>
    <div class="card">
      <div class="small">Exemple de test API :</div>
      <a class="btn" href="/api/hello" target="_blank">Appeler /api/hello</a>
    </div>
  </div>

  <!-- Zone debug (auto-cach√©e si DEBUG=false) -->
  <div id="debug" style="padding:8px;font-family:monospace;"></div>

  <!-- Ici on injecte les cards -->
  <div id="market-container" class="grid" style="margin-top:12px;"></div>

  <!-- Zone bouton pagination -->
  <div id="pagination-zone" style="text-align:center;margin:12px 0;"></div>

  <script type="module">
    // ‚úÖ Debug ON/OFF
    const DEBUG = false; // mets true si tu veux les logs
    const debug = (msg) => {
      if (!DEBUG) return;
      const el = document.getElementById("debug");
      el.style.display = "block";
      el.innerHTML += msg + "<br/>";
    };
    if (!DEBUG) {
      const el = document.getElementById("debug");
      if (el) el.style.display = "none";
    }

    // ‚úÖ Pagination params
    let PAGE = 1;
    const PAGE_SIZE = 10;
    let RESULTS_CACHE = []; // on garde les r√©sultats pr√™ts

    async function main() {
      try {
        debug("üîÑ Chargement module getBestImage‚Ä¶");

        const mod = await import("/getBestImage.js");
        const { getBestImage } = mod;

        debug("‚úÖ Module charg√©.");
        debug("üì° R√©cup√©ration des flux march√©‚Ä¶");

        const data = await fetch("/api/market").then(r => r.json());
        debug("üßæ R√©ponse brute: " + JSON.stringify(data).slice(0, 200) + "...");

        // ‚úÖ Normalisation robuste (ajout de feed)
        let items = [];

        if (Array.isArray(data)) {
          items = data;
        } else if (Array.isArray(data.feed)) {
          items = data.feed;
        } else if (Array.isArray(data.items)) {
          items = data.items;
        } else if (Array.isArray(data.results)) {
          items = data.results;
        } else if (Array.isArray(data.articles)) {
          items = data.articles;
        } else if (data.items && typeof data.items === "object") {
          items = Object.values(data.items);
        } else if (data.data && Array.isArray(data.data)) {
          items = data.data;
        }

        if (!Array.isArray(items)) items = [];
        if (items.length === 0) {
          debug("‚ö†Ô∏è Aucun item trouv√© dans les flux.");
          return;
        }

        debug(`‚úÖ ${items.length} item(s) re√ßus.`);

        // ‚úÖ Pr√©pare images + infos en parall√®le une seule fois
        RESULTS_CACHE = await Promise.all(
          items.map(async (item) => {
            const q = item.title || item.name || item.model || "Opportunit√©";
            const type = item.type || "product";
            const url = item.url || item.link || item.id || null;

            const img = await getBestImage({ q, type, url });
            return { item, img, q, type, url };
          })
        );

        // ‚úÖ Render 1√®re page
        renderPage();

        debug("üéâ Cards affich√©es (page 1).");

      } catch (e) {
        debug("‚ùå Erreur: " + e.message);
      }
    }

    function renderPage() {
      const container = document.getElementById("market-container");
      const paginationZone = document.getElementById("pagination-zone");

      const start = (PAGE - 1) * PAGE_SIZE;
      const slice = RESULTS_CACHE.slice(start, start + PAGE_SIZE);

      for (const { img, q, type, url } of slice) {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img
            src="${img.thumbUrl || img.imageUrl || "/placeholder.png"}"
            alt="${q}"
            style="width:100%;height:160px;object-fit:cover;border-radius:8px;margin-bottom:8px;"
          />
          <b>${q}</b><br/>
          <small>${type}</small>
          ${img.source === "ai-fallback" ? "<div class='small'>Illustration IA</div>" : ""}
          ${url ? `<div style="margin-top:6px;"><a class="btn" href="${url}" target="_blank">Voir la source</a></div>` : ""}
        `;

        container.appendChild(card);
      }

      // ‚úÖ Bouton Charger plus
      paginationZone.innerHTML = "";
      if (PAGE * PAGE_SIZE < RESULTS_CACHE.length) {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Charger plus";
        btn.onclick = () => {
          PAGE++;
          renderPage();
        };
        paginationZone.appendChild(btn);
      }
    }

    main();
  </script>
</body>
</html>
