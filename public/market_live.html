<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MarchÃ© en direct â€¢ MMM V10.3</title>
  <link rel="stylesheet" href="/mmm.css">

  <!-- âœ… Style filtre actif -->
  <style>
    .active-filter {
      background: #111 !important;
      color: #fff !important;
      border: 1px solid #111 !important;
    }
  </style>
</head>

<body>
  <div class="header">ðŸ“ˆ MarchÃ© en direct</div>

  <div class="grid">
    <div class="card"><b>Status:</b> prÃªt Ã  recevoir les flux. (V10.3 API)</div>
    <div class="card">
      <div class="small">Exemple de test API :</div>
      <a class="btn" href="/api/hello" target="_blank">Appeler /api/hello</a>
    </div>
  </div>

  <!-- Zone debug (auto-cachÃ©e si DEBUG=false) -->
  <div id="debug" style="padding:8px;font-family:monospace;"></div>

  <!-- âœ… Filtres amÃ©liorÃ©s (gÃ©nÃ©rÃ©s en JS) -->
  <div id="filters" style="padding:8px; display:flex; gap:6px; flex-wrap:wrap;"></div>

  <!-- Ici on injecte les cards -->
  <div id="market-container" class="grid" style="margin-top:12px;"></div>

  <!-- Zone bouton pagination -->
  <div id="pagination-zone" style="text-align:center;margin:12px 0;"></div>

  <script type="module">
    // âœ… Debug ON/OFF
    const DEBUG = false; // mets true si tu veux les logs
    const debug = (msg) => {
      if (!DEBUG) return;
      const el = document.getElementById("debug");
      el.style.display = "block";
      el.innerHTML += msg + "<br/>";
    };
    if (!DEBUG) {
      const el = document.getElementById("debug");
      if (el) el.style.display = "none";
    }

    // âœ… Pagination params
    let PAGE = 1;
    const PAGE_SIZE = 10;

    // Cache global
    let ALL_RESULTS = [];     // tous les rÃ©sultats
    let RESULTS_CACHE = [];  // rÃ©sultats filtrÃ©s courants

    async function main() {
      try {
        debug("ðŸ”„ Chargement module getBestImageâ€¦");
        const mod = await import("/getBestImage.js");
        const { getBestImage } = mod;
        debug("âœ… Module chargÃ©.");

        debug("ðŸ“¡ RÃ©cupÃ©ration des flux marchÃ©â€¦");
        const data = await fetch("/api/market").then(r => r.json());
        debug("ðŸ§¾ RÃ©ponse brute: " + JSON.stringify(data).slice(0, 200) + "...");

        // âœ… Normalisation robuste (ajout de feed)
        let items = [];
        if (Array.isArray(data)) items = data;
        else if (Array.isArray(data.feed)) items = data.feed;
        else if (Array.isArray(data.items)) items = data.items;
        else if (Array.isArray(data.results)) items = data.results;
        else if (Array.isArray(data.articles)) items = data.articles;
        else if (data.items && typeof data.items === "object") items = Object.values(data.items);
        else if (data.data && Array.isArray(data.data)) items = data.data;

        if (!Array.isArray(items) || items.length === 0) {
          debug("âš ï¸ Aucun item trouvÃ© dans les flux.");
          return;
        }

        debug(`âœ… ${items.length} item(s) reÃ§us.`);

        // âœ… PrÃ©pare images + infos en parallÃ¨le
        ALL_RESULTS = await Promise.all(
          items.map(async (item) => {
            const q = item.title || item.name || item.model || "OpportunitÃ©";
            const type = item.type || "product";
            const url = item.url || item.link || item.id || null;

            const img = await getBestImage({ q, type, url });
            return { item, img, q, type, url };
          })
        );

        // âœ… Initialise cache courant = tout
        RESULTS_CACHE = ALL_RESULTS;

        // âœ… construit filtres amÃ©liorÃ©s
        buildFilters(ALL_RESULTS);

        // âœ… Render 1Ã¨re page
        PAGE = 1;
        clearMarket();
        renderPage();

        debug("ðŸŽ‰ Cards affichÃ©es (page 1).");

      } catch (e) {
        debug("âŒ Erreur: " + e.message);
      }
    }

    function clearMarket() {
      document.getElementById("market-container").innerHTML = "";
      document.getElementById("pagination-zone").innerHTML = "";
    }

    // âœ… Ã‰tape 4: filtres avec compteur + actif + scrollTop
    function buildFilters(results) {
      const filtersDiv = document.getElementById("filters");
      filtersDiv.innerHTML = "";

      // Compter par type
      const counts = results.reduce((acc, r) => {
        const t = r.type || "product";
        acc[t] = (acc[t] || 0) + 1;
        return acc;
      }, {});

      const types = Object.keys(counts);

      // Bouton "Tout"
      const allBtn = document.createElement("button");
      allBtn.className = "btn filter-btn active-filter";
      allBtn.dataset.filter = "all";
      allBtn.textContent = `Tout (${results.length})`;
      filtersDiv.appendChild(allBtn);

      // Boutons par type
      for (const t of types) {
        const btn = document.createElement("button");
        btn.className = "btn filter-btn";
        btn.dataset.filter = t;
        btn.textContent = `${t} (${counts[t]})`;
        filtersDiv.appendChild(btn);
      }

      // Click handlers
      filtersDiv.querySelectorAll(".filter-btn").forEach(btn => {
        btn.onclick = () => {
          const filter = btn.dataset.filter;

          // Active state
          filtersDiv.querySelectorAll(".filter-btn")
            .forEach(b => b.classList.remove("active-filter"));
          btn.classList.add("active-filter");

          RESULTS_CACHE = (filter === "all")
            ? ALL_RESULTS
            : ALL_RESULTS.filter(r => r.type === filter);

          PAGE = 1;
          clearMarket();
          renderPage();

          // Remonter en haut (mobile friendly)
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
      });
    }

    function renderPage() {
      const container = document.getElementById("market-container");
      const paginationZone = document.getElementById("pagination-zone");

      const start = (PAGE - 1) * PAGE_SIZE;
      const slice = RESULTS_CACHE.slice(start, start + PAGE_SIZE);

      for (const { img, q, type, url } of slice) {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img
            src="${img.thumbUrl || img.imageUrl || "/placeholder.png"}"
            alt="${q}"
            style="width:100%;height:160px;object-fit:cover;border-radius:8px;margin-bottom:8px;"
          />
          <b>${q}</b><br/>
          <small>${type}</small>
          ${img.source === "ai-fallback" ? "<div class='small'>Illustration IA</div>" : ""}
          ${url ? `<div style="margin-top:6px;"><a class="btn" href="${url}" target="_blank">Voir la source</a></div>` : ""}
        `;

        container.appendChild(card);
      }

      // âœ… Bouton Charger plus
      paginationZone.innerHTML = "";
      if (PAGE * PAGE_SIZE < RESULTS_CACHE.length) {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Charger plus";
        btn.onclick = () => {
          PAGE++;
          renderPage();
        };
        paginationZone.appendChild(btn);
      }
    }

    main();
  </script>
</body>
</html>
