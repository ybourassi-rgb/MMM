<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Motor Y — Tableau de bord</title>
  <!-- build v10.5 — Marché dynamique + Affiliation Amazon & AliExpress -->
  <style>
    :root{
      --bg:#0c0f12; --panel:#12161b; --muted:#a9b3c1; --text:#e9eef6;
      --primary:#4da3ff; --ok:#29d38d; --chip:#1a1f25; --line:#1c232b;
      --danger:#ff6b6b; --badge:#0f1420;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    a{color:var(--primary);text-decoration:none}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:flex-start;justify-content:space-between;margin-bottom:18px}
    .title h1{margin:0 0 6px 0;font-size:28px}
    .sub{color:var(--muted)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;background:var(--badge);border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 3px #123b2e33 inset}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .module{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
    .module h3{margin:0 0 8px;font-size:18px}
    .p-muted{color:var(--muted);margin:0 0 10px}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px}
    .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:10px 14px;color:#dbe6ff}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .input, textarea{width:100%;background:#0b0f14;border:1px solid var(--line);border-radius:10px;color:#e9eef6;padding:12px}
    textarea{min-height:120px;resize:vertical}
    .btn{border:1px solid var(--line);background:#111824;color:#eaf2ff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:#2f78c7;color:#061522}
    .btn.ghost{background:#0e141b}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .response{background:#0b1118;border:1px dashed #243244;border-radius:12px;padding:12px;margin-top:12px}
    .response .title{font-weight:600;margin:0 0 6px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:10px;border:1px solid var(--line);border-radius:10px;background:#0e141a}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0c1320;border:1px solid #253043;color:#9fb4d3;font-size:12px}
    .danger{color:var(--danger)}
    footer{margin-top:22px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Money Motor Y — Tableau de bord</h1>
        <div class="sub">IA stratégique d’investissement • <span class="pill">v10.5</span></div>
      </div>
      <div class="badges">
        <span class="badge"><span class="dot" id="status-dot"></span> <span id="status-text">État IA : En ligne</span></span>
      </div>
    </header>

    <div class="chips">
      <div class="chip">Conseil d’investissement</div>
      <div class="chip">Marché en direct</div>
      <div class="chip">Analyse rapide Y-Score</div>
      <div class="chip">Alertes marché</div>
      <div class="chip">Affiliation Amazon</div>
      <div class="chip">Affiliation AliExpress</div>
    </div>

    <div class="grid">
      <!-- CONSEIL -->
      <section class="module" id="advice">
        <h3>Conseil d’investissement</h3>
        <p class="p-muted">Pose une question, colle un lien d’annonce ou décris l’opportunité.</p>
        <textarea id="advice-input" placeholder="Exemple : Est-ce une bonne affaire ?"></textarea>
        <div class="stack" style="margin-top:8px">
          <button class="btn primary" id="advice-send">Obtenir un conseil</button>
          <button class="btn ghost" id="advice-yscore">Analyser avec Y-Score</button>
          <button class="btn" id="advice-clear">Effacer</button>
        </div>
        <div class="response" id="advice-resp" style="display:none">
          <div class="title">Réponse condensée</div>
          <div id="advice-text">—</div>
        </div>
      </section>

      <!-- MARCHÉ -->
      <section class="module" id="market">
        <h3>Marché en direct</h3>
        <p class="p-muted">Flux synthétique des opportunités (auto, immo, crypto...).</p>
        <div id="market-date" class="p-muted" style="margin-bottom:10px">Chargement...</div>
        <div class="list" id="market-list"></div>
      </section>

      <!-- AFFILIATION AMAZON -->
      <section class="module" id="aff-amazon">
        <h3>Affiliation Amazon</h3>
        <p class="p-muted">Colle une URL produit Amazon, on génère un lien affilié tracké via /api/track.</p>
        <input
          id="amz-url"
          class="input"
          type="text"
          placeholder="https://www.amazon.fr/..."
        />
        <div class="stack" style="margin-top:8px">
          <button class="btn primary" id="amz-gen">Générer le lien affilié</button>
          <button class="btn ghost" id="amz-open">Tester</button>
          <button class="btn" id="amz-copy">Copier</button>
        </div>
        <div class="response" id="amz-resp" style="display:none">
          <div class="title">Lien affilié Amazon tracké</div>
          <div id="amz-link" style="word-break:break-all">—</div>
        </div>
      </section>

      <!-- AFFILIATION ALIEXPRESS -->
      <section class="module" id="aff-alix">
        <h3>Affiliation AliExpress</h3>
        <p class="p-muted">Colle une URL produit AliExpress, on génère un lien tracké via /api/track.</p>
        <input
          id="alix-url"
          class="input"
          type="text"
          placeholder="https://www.aliexpress.com/..."
        />
        <div class="stack" style="margin-top:8px">
          <button class="btn primary" id="alix-gen">Générer le lien tracké</button>
          <button class="btn ghost" id="alix-open">Tester</button>
          <button class="btn" id="alix-copy">Copier</button>
        </div>
        <div class="response" id="alix-resp" style="display:none">
          <div class="title">Lien AliExpress tracké</div>
          <div id="alix-link" style="word-break:break-all">—</div>
        </div>
      </section>
    </div>

    <footer>Money Motor Y • build v10.5 — moteur dynamique + affiliation Amazon & AliExpress</footer>
  </div>

  <script>
    // ==== CONFIG ====
    const AMAZON_TAG = "moneymotory-21"; // remplace par ton vrai tag Amazon si besoin

    async function j(url, opts){
      const r = await fetch(url, opts);
      const raw = await r.text();
      try{
        const json = JSON.parse(raw);
        if(!r.ok) throw new Error(json.error || ("Erreur " + r.status));
        return json;
      }catch{
        throw new Error(raw || ("Erreur " + r.status));
      }
    }

    // ===== BADGE ÉTAT =====
    (async () => {
      try {
        const s = await j('/api/status');
        const dot = document.getElementById('status-dot');
        const st  = document.getElementById('status-text');
        if (!s.hasOpenAIKey) {
          dot.style.background = '#ff6b6b';
          st.textContent = 'État IA : Clé OpenAI manquante';
        } else if (s.hasUpstashKV === false) {
          dot.style.background = '#ffb020';
          st.textContent = 'État IA : KV non configuré';
        } else {
          dot.style.background = '#29d38d';
          st.textContent = 'État IA : En ligne';
        }
      } catch {
        const dot = document.getElementById('status-dot');
        const st  = document.getElementById('status-text');
        dot.style.background = '#ff6b6b';
        st.textContent = 'État IA : Hors ligne';
      }
    })();

    // ===== CONSEIL (appel /api/advisor) =====
    (()=>{
      const $in   = document.getElementById('advice-input');
      const $send = document.getElementById('advice-send');
      const $clr  = document.getElementById('advice-clear');
      const $ys   = document.getElementById('advice-yscore');
      const $box  = document.getElementById('advice-resp');
      const $txt  = document.getElementById('advice-text');

      $send.addEventListener('click', async ()=>{
        const prompt = ($in.value||'').trim();
        $box.style.display = 'block';
        if(!prompt){
          $txt.innerHTML = '<span class="danger">Saisis un message.</span>';
          return;
        }
        $send.disabled = true;
        $txt.textContent = 'Analyse en cours…';
        try{
          const data = await j('/api/advisor',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ prompt })
          });
          $txt.textContent = data.reply || '—';
        }catch(e){
          $txt.innerHTML = '<span class="danger">'+ (e.message || 'Erreur') +'</span>';
        }finally{
          $send.disabled = false;
        }
      });

      $clr.addEventListener('click', ()=>{
        $in.value = '';
        $box.style.display = 'none';
        $txt.textContent = '';
      });

      $ys.addEventListener('click', ()=>{
        $box.style.display = 'block';
        $txt.textContent = '(Bientôt) Analyse Y-Score détaillée…';
      });
    })();

    // ===== MARCHÉ EN DIRECT (boutons "Voir l’offre" via /api/r) =====
    (async ()=>{
      const dateEl = document.getElementById('market-date');
      const list   = document.getElementById('market-list');
      list.innerHTML = '<div class="item">Chargement…</div>';

      function card(it){
        const div = document.createElement('div');
        div.className = 'item';
        const type = (it.type||'gen').toUpperCase();
        const time = it.updatedAtISO ? new Date(it.updatedAtISO).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) : '';
        const btn  = it.url
          ? '<a class="btn" style="margin-top:8px" target="_blank" rel="nofollow sponsored noopener" href="/api/r?u='
            + encodeURIComponent(it.url)
            + '&s=' + encodeURIComponent(it.type||'gen')
            + '">Voir l’offre</a>'
          : '';
        div.innerHTML = `
          <div><strong>${it.title||'—'}</strong> <span class="pill">${type}</span></div>
          <div class="p-muted">${time}</div>
          ${btn}
        `;
        return div;
      }

      try{
        const data = await j('/api/status');
        if (data.todayFr) dateEl.textContent = 'Aujourd’hui : ' + data.todayFr;
        list.innerHTML = '';

        const feed = Array.isArray(data.feed) ? data.feed : [];
        if (!feed.length){
          list.innerHTML = '<div class="item p-muted">Aucune opportunité disponible.</div>';
          return;
        }
        for (const it of feed) list.appendChild(card(it));
      }catch(e){
        list.innerHTML = '<div class="item danger">Erreur : '+e.message+'</div>';
      }
    })();

    // ===== AFFILIATION AMAZON (/api/track) =====

    function extractAmazonASIN(rawUrl = ''){
      const url = String(rawUrl).trim();
      if (!url) return null;
      const m = url.match(/\/([A-Z0-9]{10})(?:[/?]|$)/i);
      return m ? m[1].toUpperCase() : null;
    }

    function buildAmazonAffiliateUrl(asin){
      if (!asin) return null;
      return 'https://www.amazon.fr/dp/' + asin + '?tag=' + encodeURIComponent(AMAZON_TAG);
    }

    function buildAmazonTrackedLink(rawUrl){
      const asin = extractAmazonASIN(rawUrl);
      if (!asin) return { error:'ASIN introuvable dans l’URL Amazon.' };

      const affiliateUrl = buildAmazonAffiliateUrl(asin);
      if (!affiliateUrl) return { error:'Impossible de créer le lien affilié.' };

      const trackedUrl =
        '/api/track?platform=amazon'
        + '&product=' + encodeURIComponent(asin)
        + '&redirect=' + encodeURIComponent(affiliateUrl);

      return { asin, affiliateUrl, trackedUrl };
    }

    (()=>{
      const input = document.getElementById('amz-url');
      const btnGen = document.getElementById('amz-gen');
      const btnCopy = document.getElementById('amz-copy');
      const btnOpen = document.getElementById('amz-open');
      const box = document.getElementById('amz-resp');
      const linkEl = document.getElementById('amz-link');

      if (!input || !btnGen || !box || !linkEl) return;

      let currentLink = '';

      btnGen.addEventListener('click', ()=>{
        const raw = (input.value || '').trim();
        box.style.display = 'block';

        if (!raw){
          linkEl.innerHTML = '<span class="danger">Colle d’abord une URL Amazon.</span>';
          currentLink = '';
          return;
        }

        const res = buildAmazonTrackedLink(raw);
        if (res.error){
          linkEl.innerHTML = '<span class="danger">'+res.error+'</span>';
          currentLink = '';
          return;
        }

        currentLink = res.trackedUrl;
        linkEl.textContent = currentLink;
      });

      btnCopy.addEventListener('click', async ()=>{
        if (!currentLink) return;
        try{
          await navigator.clipboard.writeText(currentLink);
          btnCopy.textContent = 'Copié ✅';
          setTimeout(()=>{ btnCopy.textContent = 'Copier'; }, 1500);
        }catch{
          btnCopy.textContent = 'Erreur copie ❌';
          setTimeout(()=>{ btnCopy.textContent = 'Copier'; }, 1500);
        }
      });

      btnOpen.addEventListener('click', ()=>{
        if (!currentLink) return;
        window.open(currentLink, '_blank', 'noopener,noreferrer');
      });
    })();

    // ===== AFFILIATION ALIEXPRESS (/api/track) =====

    function buildAliExpressTrackedLink(rawUrl){
      const url = String(rawUrl).trim();
      if (!url || !url.toLowerCase().includes('aliexpress')) {
        return { error: 'URL AliExpress invalide.' };
      }

      // Essaie d’extraire un ID (item/123456789.html), sinon utilise l’URL complète comme identifiant
      const m = url.match(/item\/(\d+)\.html/i);
      const productId = m ? m[1] : url;

      const trackedUrl =
        '/api/track?platform=aliexpress'
        + '&product=' + encodeURIComponent(productId)
        + '&redirect=' + encodeURIComponent(url);

      return { productId, trackedUrl };
    }

    (()=>{
      const input = document.getElementById('alix-url');
      const btnGen = document.getElementById('alix-gen');
      const btnCopy = document.getElementById('alix-copy');
      const btnOpen = document.getElementById('alix-open');
      const box = document.getElementById('alix-resp');
      const linkEl = document.getElementById('alix-link');

      if (!input || !btnGen || !box || !linkEl) return;

      let currentLink = '';

      btnGen.addEventListener('click', ()=>{
        const raw = (input.value || '').trim();
        box.style.display = 'block';

        if (!raw){
          linkEl.innerHTML = '<span class="danger">Colle d’abord une URL AliExpress.</span>';
          currentLink = '';
          return;
        }

        const res = buildAliExpressTrackedLink(raw);
        if (res.error){
          linkEl.innerHTML = '<span class="danger">'+res.error+'</span>';
          currentLink = '';
          return;
        }

        currentLink = res.trackedUrl;
        linkEl.textContent = currentLink;
      });

      btnCopy.addEventListener('click', async ()=>{
        if (!currentLink) return;
        try{
          await navigator.clipboard.writeText(currentLink);
          btnCopy.textContent = 'Copié ✅';
          setTimeout(()=>{ btnCopy.textContent = 'Copier'; }, 1500);
        }catch{
          btnCopy.textContent = 'Erreur copie ❌';
          setTimeout(()=>{ btnCopy.textContent = 'Copier'; }, 1500);
        }
      });

      btnOpen.addEventListener('click', ()=>{
        if (!currentLink) return;
        window.open(currentLink, '_blank', 'noopener,noreferrer');
      });
    })();
  </script>
</body>
</html>
