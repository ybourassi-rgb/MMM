<script>
const GOOGLE_KEY = "<?= process.env.GOOGLE_SEARCH_KEY ?>";
const GOOGLE_CX  = "<?= process.env.GOOGLE_SEARCH_CX ?>";

async function fetchGoogleImage(query) {
    try {
        const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_KEY}&cx=${GOOGLE_CX}&searchType=image&q=${encodeURIComponent(query)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.items || data.items.length === 0) {
            return null;
        }

        return data.items[0].link; // première image
    } catch {
        return null;
    }
}

async function showDeal() {
    const response = await fetch("/deals/casque.json");
    const deal = await response.json();

    document.getElementById("title").innerText = deal.title;
    document.getElementById("price").innerText = deal.price;

    let imageUrl = deal.image;

    if (!imageUrl) {
        const googleImage = await fetchGoogleImage(deal.title);
        if (googleImage) {
            imageUrl = googleImage;
        }
    }

    const img = document.getElementById("product-img");

    if (imageUrl) {
        img.src = imageUrl;
    } else {
        img.src = "";
        img.innerText = "Aucune image trouvée";
    }
}

showDeal();
</script>
