<script>
async function fetchGoogleImage(query) {
  try {
    const res = await fetch("/api/googleimage?q=" + encodeURIComponent(query));
    const data = await res.json();
    if (data.ok && data.image) {
      return data.image;
    }
    return null;
  } catch (e) {
    console.error("Erreur API image:", e);
    return null;
  }
}

async function loadDeal() {
  try {
    // 1) Charger le deal statique
    const res = await fetch("/deals/casque.json");
    const deal = await res.json();

    // 2) Titre & prix
    const titleEl = document.getElementById("title");
    const priceEl = document.getElementById("price");
    if (titleEl) titleEl.innerText = deal.title || "Produit mystère";
    if (priceEl) priceEl.innerText = deal.price || "";

    // 3) Image
    const imgEl = document.getElementById("product-img");
    const noImgEl = document.getElementById("no-image");

    let imageUrl = deal.image || "";

    // Si pas d'image dans le JSON → on tente Google
    if (!imageUrl && deal.title) {
      imageUrl = await fetchGoogleImage(deal.title);
    }

    if (imageUrl && imgEl) {
      imgEl.src = imageUrl;
      imgEl.alt = deal.title || "Produit";

      if (noImgEl) {
        noImgEl.style.display = "none";
      }
    } else {
      // Pas d'image trouvée
      if (imgEl) {
        imgEl.removeAttribute("src");
        imgEl.alt = "";
      }
      if (noImgEl) {
        noImgEl.style.display = "flex";
        noImgEl.innerText = "Aucune image trouvée";
      }
    }

    // 4) Bouton CTA
    const btn = document.getElementById("cta");
    if (btn && deal.url) {
      btn.href = deal.url;
    }
  } catch (e) {
    console.error("Erreur loadDeal:", e);
  }
}

loadDeal();
</script>
