<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Motor Muslim ‚Äî Tableau de bord (V10.3)</title>

  <!-- PWA + Styles -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/mmm.css?v=1038" />
  <meta name="theme-color" content="#0b0b0b" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>
  <header class="nav" role="banner">
    <div class="brand" aria-label="Identit√© de l‚Äôapplication">
      <span class="dot" aria-hidden="true"></span>
      <span class="brand-title">Money Motor Muslim ‚Äî Tableau de bord</span>
      <span class="brand-pill" aria-label="Version">V10.3</span>
    </div>

    <div class="status-wrap" aria-live="polite">
      <span class="status-label">√âtat IA :</span>
      <span id="ia-badge" class="chip chip--pending" aria-label="Statut du serveur">V√©rification‚Ä¶</span>
    </div>
  </header>

  <main class="container" role="main">
    <!-- Apps -->
    <section class="cards-row" aria-label="Applications">
      <a class="app-card" href="/market_live.html">
        <span class="app-emoji" aria-hidden="true">üìà</span>
        <span class="app-title">March√© en direct</span>
      </a>

      <a class="app-card" href="/publish_wizard.html">
        <span class="app-emoji" aria-hidden="true">üß©</span>
        <span class="app-title">Assistant de publication</span>
      </a>

      <a class="app-card" href="/auto_publisher.html">
        <span class="app-emoji" aria-hidden="true">ü§ñ</span>
        <span class="app-title">Smart Auto-Publisher</span>
      </a>
    </section>

    <!-- Conseil instantan√© -->
    <section class="panel" aria-labelledby="panel-title">
      <header class="panel-head">
        <div id="panel-title" class="panel-title">
          <span class="title-emoji" aria-hidden="true">üí¨</span> Conseil instantan√©
        </div>
        <span id="error-dot" class="pill pill--error" hidden>Erreur</span>
      </header>

      <!-- ‚úÖ Ligne d‚Äôaide supprim√©e -->

      <div class="prompt-row">
        <label for="prompt" class="sr-only">Votre question ou vos liens</label>
        <textarea id="prompt" rows="4" class="prompt-input"
          placeholder="Ex : https://www.leboncoin.fr/ad/voitures/3084707716 ‚Äî Est-ce une bonne affaire ?"></textarea>

        <div class="prompt-actions">
          <button id="sendBtn" type="button" class="btn btn--accent">Obtenir un conseil</button>
          <button id="clearBtn" type="button" class="btn btn--ghost">Effacer</button>
        </div>
      </div>

      <div id="status" class="status-line" aria-live="polite"></div>

      <h3 class="subhead">ü™Ñ R√©ponse condens√©e</h3>
      <pre id="advice" class="answer"><span class="muted">En attente de votre demande‚Ä¶</span></pre>
    </section>
  </main>

  <!-- JS -->
  <script>
    // ---- V√©rif du statut API ----
    (async () => {
      const badge = document.getElementById('ia-badge');
      try {
        const r = await fetch('/api/status?ts=' + Date.now(), { cache: 'no-store' });
        const j = await r.json();
        if (j && j.ok) {
          badge.textContent = 'En ligne';
          badge.className = 'chip chip--ok';
        } else {
          badge.textContent = 'Hors ligne';
          badge.className = 'chip chip--ko';
        }
      } catch {
        badge.textContent = 'Hors ligne';
        badge.className = 'chip chip--ko';
      }
    })();

    // ---- Advisor ----
    const apiUrl    = '/api/advisor';
    const promptEl  = document.getElementById('prompt');
    const sendBtn   = document.getElementById('sendBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const statusEl  = document.getElementById('status');
    const adviceEl  = document.getElementById('advice');
    const errorDot  = document.getElementById('error-dot');

    const setError = (msg) => {
      errorDot.hidden = !msg;
      if (msg) errorDot.textContent = msg;
    };

    const setLoading = (isLoading) => {
      sendBtn.disabled = isLoading;
      if (isLoading) {
        statusEl.innerHTML = '<span class="spinner"></span> Je r√©fl√©chis‚Ä¶';
        adviceEl.textContent = '';
      } else {
        statusEl.textContent = '';
      }
    };

    clearBtn.addEventListener('click', () => {
      promptEl.value = '';
      adviceEl.innerHTML = '<span class="muted">En attente de votre demande‚Ä¶</span>';
      setError('');
    });

    promptEl.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') sendBtn.click();
    });

    sendBtn.addEventListener('click', async () => {
      const prompt = (promptEl.value || '').trim();
      if (!prompt) {
        setError('√âcris une question ou colle un lien.');
        return;
      }
      setError('');
      setLoading(true);
      try {
        const r = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data?.error || 'Erreur inconnue');
        adviceEl.textContent = data.reply || '‚ö†Ô∏è Aucune r√©ponse re√ßue.';
      } catch (e) {
        setError('Erreur');
        adviceEl.textContent = '‚ùå ' + (e.message || 'Erreur r√©seau');
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
