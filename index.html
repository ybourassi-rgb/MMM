<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Motor Muslim â€” Tableau de bord (V10.4)</title>

  <!-- PWA + Styles -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="preload" href="/mmm.css?v=1040" as="style">
  <link rel="stylesheet" href="/mmm.css?v=1040" />
  <meta name="theme-color" content="#0b0b0b" />
  <meta name="color-scheme" content="dark light">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://api.openai.com" crossorigin>
</head>

<body>
  <header class="nav" role="banner">
    <div class="brand" aria-label="IdentitÃ© de lâ€™application">
      <span class="dot" aria-hidden="true"></span>
      <span class="brand-title">Money Motor Muslim â€” Tableau de bord</span>
      <span class="brand-pill" aria-label="Version">V10.4</span>
    </div>

    <div class="status-wrap" aria-live="polite">
      <span class="status-label">Ã‰tat IA :</span>
      <span id="ia-badge" class="chip chip--pending" aria-label="Statut du serveur">VÃ©rificationâ€¦</span>
    </div>
  </header>

  <main class="container" role="main">
    <!-- Apps -->
    <section class="cards-row" aria-label="Applications">
      <a class="app-card" href="/market_live.html">
        <span class="app-emoji" aria-hidden="true">ðŸ“ˆ</span>
        <span class="app-title">MarchÃ© en direct</span>
      </a>

      <a class="app-card" href="/publish_wizard.html">
        <span class="app-emoji" aria-hidden="true">ðŸ§©</span>
        <span class="app-title">Assistant de publication</span>
      </a>

      <a class="app-card" href="/auto_publisher.html">
        <span class="app-emoji" aria-hidden="true">ðŸ¤–</span>
        <span class="app-title">Smart Auto-Publisher</span>
      </a>
    </section>

    <!-- Conseil instantanÃ© -->
    <section class="panel" aria-labelledby="panel-title">
      <header class="panel-head">
        <div id="panel-title" class="panel-title">
          <span class="title-emoji" aria-hidden="true">ðŸ’¬</span> Conseil instantanÃ©
        </div>
        <span id="error-dot" class="pill pill--error" hidden>Erreur</span>
      </header>

      <div class="prompt-row">
        <label for="prompt" class="sr-only">Votre question ou vos liens</label>
        <textarea id="prompt" rows="4" class="prompt-input"
          placeholder="Ex : https://www.leboncoin.fr/ad/voitures/3084707716 â€” Est-ce une bonne affaire ?"></textarea>

        <div class="prompt-actions">
          <button id="sendBtn" type="button" class="btn btn--accent">Obtenir un conseil</button>
          <button id="clearBtn" type="button" class="btn btn--ghost">Effacer</button>
        </div>
      </div>

      <div id="status" class="status-line" aria-live="polite"></div>

      <h3 class="subhead">ðŸª„ RÃ©ponse condensÃ©e</h3>
      <pre id="advice" class="answer"><span class="muted">En attente de votre demandeâ€¦</span></pre>
    </section>

    <!-- ðŸ”½ Nouvelle section : Analyse rapide Y-Score -->
    <section id="mmy-analyse" style="margin:16px 0;padding:12px;border:1px solid #333;border-radius:12px;background:#0b0b0b">
      <h3 style="margin:0 0 8px">Analyse rapide Y-Score</h3>

      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
        <input id="mmy-price" type="number" placeholder="Prix (â‚¬)" />
        <input id="mmy-mv" type="number" placeholder="Valeur marchÃ© (â‚¬)" />
        <input id="mmy-risk" type="number" placeholder="Risque (0â€“100)" />
        <input id="mmy-days" type="number" placeholder="Jours avant revente" />
        <input id="mmy-strat" type="number" placeholder="StratÃ©gique (0â€“100)" />
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="mmy-run">Analyser</button>
        <button id="mmy-clear" style="opacity:.8">Effacer</button>
      </div>

      <div id="mmy-result" style="margin-top:10px;padding:10px;border:1px dashed #444;border-radius:10px"></div>
      <div id="mmy-history" style="margin-top:10px"></div>
    </section>
  </main>

  <!-- JS -->
  <script>
    // ---- Cache-buster global ----
    const V = '1040';

    // ---- Service Worker (PWA) ----
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').catch(() => {});
    }

    // ---- VÃ©rif du statut API ----
    (async () => {
      const badge = document.getElementById('ia-badge');
      try {
        const r = await fetch('/api/status?ts=' + Date.now(), { cache: 'no-store' });
        const j = await r.json();
        if (j && j.ok) {
          badge.textContent = 'En ligne';
          badge.className = 'chip chip--ok';
        } else {
          badge.textContent = 'Hors ligne';
          badge.className = 'chip chip--ko';
        }
      } catch {
        badge.textContent = 'Hors ligne';
        badge.className = 'chip chip--ko';
      }
    })();

    // ---- Advisor ----
    const apiUrl = '/api/advisor';
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');
    const adviceEl = document.getElementById('advice');
    const errorDot = document.getElementById('error-dot');

    const setError = (msg) => {
      errorDot.hidden = !msg;
      if (msg) errorDot.textContent = msg;
    };

    const setLoading = (isLoading) => {
      sendBtn.disabled = isLoading;
      if (isLoading) {
        statusEl.innerHTML = '<span class="spinner"></span> Je rÃ©flÃ©chisâ€¦';
        adviceEl.textContent = '';
      } else {
        statusEl.textContent = '';
      }
    };

    clearBtn.addEventListener('click', () => {
      promptEl.value = '';
      adviceEl.innerHTML = '<span class="muted">En attente de votre demandeâ€¦</span>';
      setError('');
    });

    promptEl.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') sendBtn.click();
    });

    sendBtn.addEventListener('click', async () => {
      const prompt = (promptEl.value || '').trim();
      if (!prompt) {
        setError('Ã‰cris une question ou colle un lien.');
        return;
      }
      setError('');
      setLoading(true);
      try {
        const r = await fetch(apiUrl + '?v=' + V, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data?.error || 'Erreur inconnue');
        adviceEl.textContent = data.reply || 'âš ï¸ Aucune rÃ©ponse reÃ§ue.';
        statusEl.textContent = 'âœ… RÃ©ponse gÃ©nÃ©rÃ©e';
      } catch (e) {
        setError('Erreur');
        adviceEl.textContent = 'âŒ ' + (e.message || 'Erreur rÃ©seau');
      } finally {
        setLoading(false);
      }
    });

    // ---- Analyse rapide Y-Score ----
    (function () {
      const $ = id => document.getElementById(id);
      const resBox = $('mmy-result');
      const histBox = $('mmy-history');

      function saveHistory(item) {
        const key = 'mmy.history';
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        arr.unshift(item);
        localStorage.setItem(key, JSON.stringify(arr.slice(0, 10)));
        renderHistory();
      }

      function renderHistory() {
        const arr = JSON.parse(localStorage.getItem('mmy.history') || '[]');
        if (!arr.length) { histBox.innerHTML = ''; return; }
        histBox.innerHTML = `
          <h4 style="margin:12px 0 6px;">DerniÃ¨res analyses</h4>
          <ul style="margin:0;padding-left:18px">
            ${arr.map(a => `
              <li>Score <b>${a.yScore}</b> â€” DÃ©cision <b>${a.decision}</b> â€” Profit â‚¬${a.profitAbs} (${a.profitPct}%)
                <small style="opacity:.7"> Â· ${new Date(a.createdAt).toLocaleString()}</small>
              </li>`).join('')}
          </ul>`;
      }

      $('mmy-run').addEventListener('click', async () => {
        const body = {
          price: +$('mmy-price').value,
          marketValue: +$('mmy-mv').value,
          risk: +$('mmy-risk').value,
          daysToLiquidity: +$('mmy-days').value,
          strategic: +$('mmy-strat').value
        };
        resBox.textContent = 'Calcul en coursâ€¦';
        try {
          const r = await fetch('/api/yscore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const data = await r.json();
          if (!r.ok) {
            resBox.innerHTML = `<span style="color:#f55">Erreur:</span> ${data.error || 'API'}`;
            return;
          }
          resBox.innerHTML = `
            <div>Y-Score : <b>${data.yScore}</b></div>
            <div>DÃ©cision : <b>${data.decision}</b></div>
            <div>Profit : <b>â‚¬${data.profitAbs}</b> (${data.profitPct}%)</div>`;
          saveHistory(data);
        } catch (e) {
          resBox.innerHTML = `<span style="color:#f55">Erreur rÃ©seau :</span> ${e}`;
        }
      });

      $('mmy-clear').addEventListener('click', () => {
        ['mmy-price', 'mmy-mv', 'mmy-risk', 'mmy-days', 'mmy-strat'].forEach(id => $(id).value = '');
        resBox.innerHTML = '';
      });

      renderHistory();
    })();
  </script>
  <!-- === Panneau Y-Score === -->
<div id="yscore-panel"></div>

<script src="components/yscore_panel.js"></script>
<script>
  // Monte le panneau sur la page
  window.YScorePanel.mount("yscore-panel");
</script></body>
</html>
