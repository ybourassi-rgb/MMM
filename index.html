<script>
  // -------------------------------
  // Helper RSS: passe par le proxy Node (/api/rss_fetch)
  // -------------------------------
  async function fetchRSS(url, max = 12) {
    const r = await fetch(`/api/rss_fetch?u=${encodeURIComponent(url)}&max=${max}`, { cache:'no-store' });
    const data = await r.json();
    if (!data.ok) throw new Error(data.error || 'RSS error');
    // normalise vers {title, link, source, pubDate}
    return data.items.map(x => ({
      title: x.title,
      link: x.link,
      source: data.source,
      pubDate: x.pubDate || ''
    }));
  }

  // -------------------------------
  // MARCHÉ EN DIRECT : Chargement & rendu
  // -------------------------------
  (async () => {
    // 1) Affiche la date "Aujourd'hui" depuis le serveur (via /api/status)
    try {
      const s = await fetch('/api/status', { cache:'no-store' }).then(r=>r.json());
      const dateNode = document.querySelector('#market-today-text');
      if (dateNode && s?.todayFr) dateNode.textContent = s.todayFr;
    } catch {}

    // 2) Sélectionne le conteneur de la liste
    const list = document.querySelector('#market-list');
    if (!list) return;

    // 3) Déclare tes flux (tu peux en ajouter/retirer facilement)
    //    On met un "type" pour l’étiquette (CRYPTO / BUSINESS / TECH / IMMO / AUTO / GEN)
    const SOURCES = [
      // --- CRYPTO (FR/EN)
      { url:'https://www.cointribune.com/feed/',        type:'CRYPTO' },
      { url:'https://cointelegraph.com/rss',            type:'CRYPTO' },
      { url:'https://www.coindesk.com/arc/outboundfeeds/rss/?outputType=xml', type:'CRYPTO' },

      // --- BUSINESS/FINANCE (FR)
      { url:'https://www.lesechos.fr/rss/rss_finance_marches.xml', type:'BUSINESS' },
      { url:'https://bfmbusiness.bfmtv.com/rss/cryptomonnaie/',     type:'BUSINESS' },

      // --- TECH (FR)
      { url:'https://www.usine-digitale.fr/rss',        type:'TECH' },

      // --- IMMO (FR) — exemple
      { url:'https://www.capital.fr/immobilier/feed',   type:'IMMO' },
    ];

    // 4) Charge tout en // avec timeouts gérés côté API; on ignore les flux en erreur
    let all = [];
    const results = await Promise.allSettled(
      SOURCES.map(src => fetchRSS(src.url, 8).then(items => items.map(it => ({ ...it, type: src.type }))))
    );
    for (const r of results) {
      if (r.status === 'fulfilled' && Array.isArray(r.value)) {
        all.push(...r.value);
      } else {
        // Optionnel: log discret en console pour diagnostiquer un flux qui bloque
        // console.warn('[RSS fail]', r.reason);
      }
    }

    // 5) Tri par date si possible (sinon on garde l’ordre d’arrivée)
    all = all.map(it => {
      const ts = Date.parse(it.pubDate || '') || 0;
      return { ...it, _ts: ts };
    }).sort((a,b) => b._ts - a._ts);

    // 6) Rendu des cartes (on garde ton style “Voir l’offre” via /api/r)
    list.innerHTML = ''; // reset si besoin

    if (!all.length) {
      const empty = document.createElement('div');
      empty.className = 'item';
      empty.textContent = 'Aucune opportunité pour le moment.';
      list.appendChild(empty);
      return;
    }

    // limite d’items pour ne pas surcharger la page
    const MAX_CARDS = 25;
    for (const it of all.slice(0, MAX_CARDS)) {
      const card = document.createElement('div');
      card.className = 'item';

      // Titre + badge type
      const title = document.createElement('div');
      title.innerHTML = `<strong>${it.title}</strong> <span class="pill">${(it.type || 'GEN')}</span>`;
      card.appendChild(title);

      // Heures (si dispo)
      if (it._ts) {
        const meta = document.createElement('div');
        meta.className = 'p-muted';
        try {
          meta.textContent = new Date(it._ts).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        } catch {
          meta.textContent = '';
        }
        card.appendChild(meta);
      }

      // Bouton "Voir l’offre" (passe par /api/r pour tracking affilié / whitelist)
      const a = document.createElement('a');
      a.className = 'btn';
      a.textContent = 'Voir l’offre';
      a.href = `/api/r?u=${encodeURIComponent(it.link)}&s=${encodeURIComponent((it.type||'gen').toLowerCase())}`;
      a.target = '_blank';
      a.rel = 'noopener';
      a.style.marginTop = '8px';
      card.appendChild(a);

      list.appendChild(card);
    }
  })();
</script>
