<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Motor Muslim ‚Äî Tableau de bord (V10.3)</title>

  <!-- PWA + styles -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/mmm.css" />
  <meta name="theme-color" content="#0b0b0b" />
</head>

<body>
  <header class="header">
    <div class="wrap">
      <h1>Money Motor Muslim ‚Äî Tableau de bord (V10.3)</h1>
      <div class="ia-state">
        <span>√âtat IA :</span>
        <span id="ia-badge" class="pill">V√©rification‚Ä¶</span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Cartes rapides -->
    <div class="cards">
      <a class="btn" href="/market_live.html">üìà March√© en direct</a>
      <a class="btn" href="/publish_wizard.html">üß© Assistant de publication</a>
      <a class="btn" href="/auto_publisher.html">ü§ñ Smart Auto-Publisher</a>
    </div>

    <!-- Conseil instantan√© -->
    <section class="card">
      <div class="card-head">
        <h2>üí¨ Conseil instantan√©</h2>
        <span id="error-pill" class="pill pill-error" style="display:none">Erreur</span>
      </div>

      <p class="muted">
        Collez une ou plusieurs annonces (Leboncoin, LaCentrale, Avito‚Ä¶) <em>ou</em> posez une question.
      </p>

      <textarea id="prompt" rows="5"
        placeholder="Ex : Voici une annonce : https://www.leboncoin.fr/ad/voitures/3084707716 ‚Äî Est-ce une bonne affaire ?"></textarea>

      <div class="actions">
        <button id="sendBtn" class="btn primary">Obtenir un conseil</button>
        <button id="clearBtn" class="btn">Effacer</button>
      </div>

      <div id="status" class="status"></div>

      <h3>ü™Ñ R√©ponse condens√©e</h3>
      <pre id="advice" class="mono"></pre>
    </section>
  </main>

  <script>
    // --- config anti-cache l√©ger
    const V = '1032'; // incr√©mente quand tu d√©ploies

    // -------- Badge "√âtat IA"
    (async function checkStatus() {
      const badge = document.getElementById('ia-badge');
      try {
        const r = await fetch(`/api/status?v=${V}`, { cache: 'no-store' });
        const data = await r.json().catch(() => ({}));
        const ok = !!(data && data.ok);
        badge.textContent = ok ? 'En ligne ‚úÖ' : 'Hors ligne ‚ùå';
        badge.classList.toggle('ok', ok);
        badge.classList.toggle('ko', !ok);
      } catch {
        badge.textContent = 'Hors ligne ‚ùå';
        badge.classList.remove('ok');
        badge.classList.add('ko');
      }
    })();

    // -------- Conseil instantan√©
    (function wireAdvisor() {
      const promptEl = document.getElementById('prompt');
      const sendBtn  = document.getElementById('sendBtn');
      const clearBtn = document.getElementById('clearBtn');
      const adviceEl = document.getElementById('advice');
      const statusEl = document.getElementById('status');
      const errPill  = document.getElementById('error-pill');

      function showStatus(msg, type='info') {
        statusEl.textContent = msg || '';
        statusEl.className = `status ${type}`;
      }
      function showError(msg) {
        errPill.style.display = '';
        showStatus(msg, 'error');
      }
      function clearError() {
        errPill.style.display = 'none';
        showStatus('');
      }

      clearBtn.addEventListener('click', () => {
        promptEl.value = '';
        adviceEl.textContent = '';
        clearError();
      });

      sendBtn.addEventListener('click', async () => {
        const prompt = (promptEl.value || '').trim();
        adviceEl.textContent = '';
        clearError();

        if (!prompt) {
          showError('üí¨ √âcris une question ou colle un lien d‚Äôannonce.');
          return;
        }

        showStatus('‚è≥ Analyse en cours‚Ä¶', 'info');
        sendBtn.disabled = true;

        try {
          const r = await fetch(`/api/advisor?v=${V}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });

          // Gestion explicite des erreurs r√©seau/API
          if (!r.ok) {
            // essaye de lire un JSON d'erreur structur√©
            let txt = await r.text();
            try {
              const j = JSON.parse(txt);
              txt = j.error || j.message || txt;
            } catch {}
            throw new Error(txt || `Erreur HTTP ${r.status}`);
          }

          const data = await r.json();
          if (data && data.ok) {
            adviceEl.textContent = data.reply || data.answer || '(R√©ponse vide)';
            showStatus('‚úÖ R√©ponse g√©n√©r√©e avec succ√®s', 'success');
          } else {
            throw new Error(data?.error || 'R√©ponse invalide');
          }
        } catch (e) {
          showError('‚ùå ' + (e.message || 'Load failed'));
        } finally {
          sendBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
