<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Motor Muslim ‚Äî Tableau de bord (V10.3)</title>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/mmm.css" />
  <meta name="theme-color" content="#0b0b0b" />
  <style>
    .muted{opacity:.75}
    .loader{display:inline-block; width:1em; height:1em; border:.18em solid #666; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-.2em}
    @keyframes spin{to{transform:rotate(360deg)}}
    #advice { white-space: normal; }
    #advice h3 { margin: .6rem 0 .2rem }
    #advice ul { margin:.25rem 0 .75rem .9rem }
    #advice li { margin:.15rem 0 }
    .ok{color:#38c172} .bad{color:#ff4d4f}
  </style>
</head>
<body>
  <div class="header">Money Motor Muslim ‚Äî Tableau de bord (V10.3)</div>

  <div class="grid">
    <!-- √âtat IA -->
    <div class="card">
      <div>
        <b>√âtat IA :</b>
        <span id="ia-badge" class="muted">V√©rification‚Ä¶</span>
      </div>
      <div class="small muted">Serveur API c√¥t√© Vercel ‚Ä¢ PWA installable ‚Ä¢ 100 % licite</div>
      <div style="margin-top:10px">
        <a class="btn" href="/market_live.html">üìà March√© en direct</a>
        <a class="btn" href="/publish_wizard.html">üß© Assistant de publication</a>
        <a class="btn" href="/auto_publisher.html">ü§ñ Smart Auto-Publisher</a>
      </div>
    </div>

    <!-- Conseil instantan√© -->
    <div class="card">
      <div style="margin-bottom:8px;"><b>Conseil instantan√©</b></div>
      <input id="topic" placeholder="Ex: ench√®res voitures Maroc"
             style="width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0f0f0f;color:#f2f2f2">
      <button class="btn" id="btn-ask" style="margin-top:10px;">Obtenir un conseil</button>
      <div id="advice" class="small muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <script>
    // --- 1) Badge de statut (domaine actuel) ---
    (async () => {
      const badge = document.getElementById('ia-badge');
      try {
        const r = await fetch('/api/status', { cache: 'no-store' });
        const data = await r.json().catch(()=> ({}));
        if (data && (data.ok || data.status === 'online')) {
          badge.innerHTML = '<span class="ok">En ligne ‚úÖ</span>';
          badge.classList.remove('muted');
        } else {
          badge.innerHTML = '<span class="bad">Hors ligne ‚ùå</span>';
        }
      } catch {
        badge.innerHTML = '<span class="bad">Hors ligne ‚ùå</span>';
      }
    })();

    // --- 2) Mini-formatteur Markdown -> HTML safe ---
    function mdToHtml(md) {
      let html = md
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); // √©chappement
      html = html.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");               // **gras**
      html = html.replace(/^### (.+)$/gm, "<h3>$1</h3>");                // ### titre
      // listes simples
      html = html
        .split(/\n\n+/).map(block=>{
          if (/^[-*] /.test(block.trim())) {
            return "<ul>" + block.trim().split(/\n/)
              .map(li => "<li>" + li.replace(/^[-*] /,'') + "</li>").join("") + "</ul>";
          }
          return "<p>" + block.replace(/\n/g,"<br>") + "</p>";
        }).join("");
      return html;
    }

    // --- 3) C√¢blage du bouton (loader + rendu propre) ---
    (function attachAdvisor(){
      const input = document.getElementById('topic');
      const btn   = document.getElementById('btn-ask');
      const out   = document.getElementById('advice');
      if (!btn || !out) return;

      btn.addEventListener('click', async () => {
        const prompt = (input.value || '').trim();
        if (!prompt) { out.innerHTML = 'üí¨ √âcris une question.'; return; }

        btn.disabled = true;
        out.classList.remove('muted');
        out.innerHTML = '<span class="loader"></span> R√©flexion en cours‚Ä¶';

        try {
          const r = await fetch('/api/advisor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });
          const data = await r.json();
          if (!data.ok) throw new Error(data.error || 'Erreur inconnue');
          out.innerHTML = mdToHtml(data.reply);
        } catch (e) {
          out.innerHTML = '‚ùå ' + (e.message || 'Erreur');
        } finally {
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
