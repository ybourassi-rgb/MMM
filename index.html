<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Motor Muslim ‚Äî Tableau de bord (V10.3)</title>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/mmm.css" />
  <meta name="theme-color" content="#0b0b0b" />
  <style>
    .muted{opacity:.75}
    .ok{color:#38c172} .bad{color:#ff4d4f}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .loader{display:inline-block; width:1em; height:1em; border:.18em solid #666; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-.2em}
    @keyframes spin{to{transform:rotate(360deg)}}
    #advice { white-space: normal; margin-top:8px }
    #advice ul{margin:.2rem 0 .6rem 1.1rem}
    #advice li{margin:.18rem 0}
    .pill{font-size:.85rem;border:1px solid #333;border-radius:999px;padding:.4rem .7rem;background:#101010}
    .btn-ghost{border:1px solid #333;background:#0f0f0f;color:#eee;border-radius:8px;padding:.55rem .8rem;cursor:pointer}
    .btn-ghost[disabled]{opacity:.55;cursor:not-allowed}
    .cap{font-variant:all-small-caps; letter-spacing:.04em; opacity:.8}
  </style>
</head>
<body>
  <div class="header">Money Motor Muslim ‚Äî Tableau de bord (V10.3)</div>

  <div class="grid">
    <!-- √âtat IA -->
    <div class="card">
      <div class="row">
        <b>√âtat IA :</b>
        <span id="ia-badge" class="muted">V√©rification‚Ä¶</span>
        <span id="using-key" class="pill cap muted" title="Nom de la variable d‚Äôenvironnement d√©tect√©e" style="display:none"></span>
      </div>
      <div class="small muted">Serveur API c√¥t√© Vercel ‚Ä¢ PWA installable ‚Ä¢ 100 % licite</div>
      <div style="margin-top:10px">
        <a class="btn" href="/market_live.html">üìà March√© en direct</a>
        <a class="btn" href="/publish_wizard.html">üß© Assistant de publication</a>
        <a class="btn" href="/auto_publisher.html">ü§ñ Smart Auto-Publisher</a>
      </div>
    </div>

    <!-- Conseil instantan√© -->
    <div class="card">
      <div style="margin-bottom:8px;"><b>Conseil instantan√©</b></div>
      <input id="topic" placeholder="Ex: ench√®res voitures Maroc"
             style="width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0f0f0f;color:#f2f2f2">
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btn-ask">Obtenir un conseil</button>
        <button class="btn-ghost" id="btn-copy" title="Copier la r√©ponse" style="display:none">üìã Copier</button>
        <span class="muted cap" id="bullets-note" style="display:none">r√©ponse condens√©e</span>
      </div>
      <div id="advice" class="small muted"></div>
    </div>
  </div>

  <script>
    // --- 1) Badge de statut ---
    (async () => {
      const badge = document.getElementById('ia-badge');
      try {
        const r = await fetch('/api/status', { cache: 'no-store' });
        const data = await r.json().catch(()=> ({}));
        if (data && (data.ok || data.status === 'online')) {
          badge.innerHTML = '<span class="ok">En ligne ‚úÖ</span>';
          badge.classList.remove('muted');
        } else {
          badge.innerHTML = '<span class="bad">Hors ligne ‚ùå</span>';
        }
        // si ton /api/status expose whichKey (optionnel), on l'affiche
        if (data && data.whichKey) {
          const chip = document.getElementById('using-key');
          chip.textContent = data.whichKey;
          chip.style.display = 'inline-block';
        }
      } catch {
        badge.innerHTML = '<span class="bad">Hors ligne ‚ùå</span>';
      }
    })();

    // --- 2) Condenseur en puces (strict & court) ---
    function toBullets(text, maxBullets = 8, maxChars = 1100) {
      // a) coupe le gros texte
      const t = text.replace(/\s+/g,' ').trim().slice(0, maxChars);

      // b) d√©coupe en phrases
      const sentences = t
        .split(/(?<=[\.\!\?])\s+(?=[A-Z√Ä√Ç√Ñ√á√â√à√ä√ã√é√è√î√ñ√ô√õ√ú≈∏0-9])/)
        .map(s => s.replace(/^[-‚Ä¢\*]\s*/,'').trim())
        .filter(Boolean);

      // c) garde les plus ‚Äúutiles‚Äù (√©vite les phrases trop courtes)
      const picked = [];
      for (const s of sentences) {
        if (picked.length >= maxBullets) break;
        if (s.length < 30) continue;
        picked.push(s);
      }
      // fallback si rien de long
      if (!picked.length) picked.push(t);

      // d) renvoie HTML <ul><li>‚Ä¶</li></ul>
      return "<ul>" + picked.map(x => "<li>"+escapeHtml(x)+"</li>").join("") + "</ul>";
    }

    // √©chappement minimal
    function escapeHtml(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}

    // --- 3) Bouton & copier ---
    (function attachAdvisor(){
      const input = document.getElementById('topic');
      const btn   = document.getElementById('btn-ask');
      const out   = document.getElementById('advice');
      const copy  = document.getElementById('btn-copy');
      const tag   = document.getElementById('bullets-note');
      if (!btn || !out) return;

      let lastRaw = ""; // pour copier le texte brut

      btn.addEventListener('click', async () => {
        const prompt = (input.value || '').trim();
        if (!prompt) { out.innerHTML = 'üí¨ √âcris une question.'; return; }

        btn.disabled = true; copy.style.display = 'none'; tag.style.display = 'none';
        out.classList.remove('muted');
        out.innerHTML = '<span class="loader"></span> R√©flexion en cours‚Ä¶';

        try {
          const r = await fetch('/api/advisor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });
          const data = await r.json();
          if (!data.ok) throw new Error(data.error || 'Erreur inconnue');

          lastRaw = (data.reply || "").trim();
          // rendu en puces strict
          out.innerHTML = toBullets(lastRaw, 8, 1100);
          copy.style.display = 'inline-block';
          tag.style.display  = 'inline-block';
        } catch (e) {
          out.innerHTML = '‚ùå ' + (e.message || 'Erreur');
        } finally {
          btn.disabled = false;
        }
      });

      copy.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(lastRaw || out.innerText || "");
          copy.textContent = "‚úÖ Copi√©";
          setTimeout(()=> copy.textContent = "üìã Copier", 1400);
        } catch {
          copy.textContent = "‚ùå Erreur copie";
          setTimeout(()=> copy.textContent = "üìã Copier", 1400);
        }
      });
    })();
  </script>
</body>
</html>
