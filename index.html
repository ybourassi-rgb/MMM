<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Motor Muslim â€” Tableau de bord (V10.3)</title>

  <!-- PWA / styles -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/mmm.css" />
  <meta name="theme-color" content="#0b0b0b" />
</head>

<body>
  <!-- En-tÃªte -->
  <header class="header">
    <div class="container header-row">
      <div class="brand">Money Motor Muslim â€” Tableau de bord (V10.3)</div>
      <div class="health">
        <span class="muted">Ã‰tat IA :</span>
        <span id="ia-badge" class="chip">VÃ©rificationâ€¦</span>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top:18px">
    <!-- Raccourcis -->
    <section class="card" style="margin-bottom:16px">
      <div class="actions" style="gap:8px; flex-wrap:wrap">
        <a class="btn" href="/market_live.html">ğŸ“ˆ MarchÃ© en direct</a>
        <a class="btn" href="/publish_wizard.html">ğŸ§© Assistant de publication</a>
        <a class="btn" href="/auto_publisher.html">ğŸ¤– Smart Auto-Publisher</a>
      </div>
      <div class="small muted" style="margin-top:8px">
        Serveur API cÃ´tÃ© Vercel â€¢ PWA installable â€¢ 100&nbsp;% licite
      </div>
    </section>

    <!-- Conseil instantanÃ© -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">ğŸ’¬ Conseil instantanÃ©</div>
        <div class="chip chip-ok" id="chip-ok" hidden>RÃ©ponse gÃ©nÃ©rÃ©e</div>
        <div class="chip chip-err" id="chip-err" hidden>Erreur</div>
      </div>

      <label class="field-label" for="topic">
        Collez une ou plusieurs annonces (Leboncoin, LaCentrale, Avitoâ€¦) <span class="muted">(ou posez une question)</span>
      </label>

      <textarea id="topic" rows="4" class="input"
        placeholder="Ex : Voici une annonce : https://www.leboncoin.fr/ad/voitures/3084707716 â€” Est-ce une bonne affaire ?"></textarea>

      <div class="actions" style="gap:10px; margin-top:10px">
        <button class="btn btn-primary" id="btn-ask" type="button">
          <span id="ask-spin" class="spinner" hidden></span>
          Obtenir un conseil
        </button>
        <button class="btn" id="btn-clear" type="button">Effacer</button>
      </div>

      <div id="advice" class="output" aria-live="polite" style="margin-top:12px"></div>
    </section>
  </main>

  <!-- Script app -->
  <script>
  // --- IA Status (badge) ---
  (async function checkStatus() {
    const badge = document.getElementById('ia-badge');
    try {
      const r = await fetch('/api/status', { cache: 'no-store' });
      const j = await r.json().catch(() => ({}));
      if (j && (j.ok || j.status === 'online')) {
        badge.textContent = 'En ligne âœ…';
        badge.classList.add('chip-ok');
      } else {
        badge.textContent = 'Hors ligne âŒ';
        badge.classList.add('chip-err');
      }
    } catch {
      badge.textContent = 'Hors ligne âŒ';
      badge.classList.add('chip-err');
    }
  })();

  // --- Conseil instantanÃ© ---
  (function wireUI() {
    const apiUrl   = '/api/advisor';
    const $topic   = document.getElementById('topic');
    const $ask     = document.getElementById('btn-ask');
    const $clear   = document.getElementById('btn-clear');
    const $out     = document.getElementById('advice');
    const $ok      = document.getElementById('chip-ok');
    const $err     = document.getElementById('chip-err');
    const $spin    = document.getElementById('ask-spin');

    function resetChips() {
      $ok.hidden = true;
      $err.hidden = true;
    }

    function toHtml(text) {
      // Affichage simple : on prÃ©serve les sauts de ligne et on met en forme les titres '##'
      const esc = (s) => s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const lines = esc(text).split('\n').map(l => {
        if (l.startsWith('### ')) return '<h4>' + l.slice(4) + '</h4>';
        if (l.startsWith('## '))  return '<h3>' + l.slice(3) + '</h3>';
        if (l.startsWith('**') && l.endsWith('**')) return '<strong>' + l.slice(2,-2) + '</strong>';
        return l;
      });
      return '<pre class="mono">'+ lines.join('\n') +'</pre>';
    }

    async function ask() {
      resetChips();
      const prompt = ($topic.value || '').trim();
      if (!prompt) {
        $out.innerHTML = '<div class="callout err">ğŸ’¬ Ã‰cris une question ou colle un lien dâ€™annonce.</div>';
        return;
      }

      try {
        $ask.disabled = true;
        $spin.hidden  = false;
        $out.innerHTML = '<div class="muted">â³ Analyse en coursâ€¦</div>';

        const r = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        const text = await r.text();  // tolÃ©rant: parfois lâ€™API renvoie du texte
        let data;
        try { data = JSON.parse(text); } catch { data = { ok:false, error:text }; }

        if (!r.ok || !data.ok) {
          $err.hidden = false;
          const msg = (data && data.error) ? data.error : ('Erreur HTTP '+ r.status);
          $out.innerHTML = '<div class="callout err">âŒ '+ msg +'</div>';
          return;
        }

        $ok.hidden = false;
        const reply = data.reply || data.answer || '';
        $out.innerHTML = toHtml(reply);
      } catch (e) {
        $err.hidden = false;
        $out.innerHTML = '<div class="callout err">âŒ ' + (e.message || 'Erreur rÃ©seau') + '</div>';
      } finally {
        $ask.disabled = false;
        $spin.hidden  = true;
      }
    }

    $ask.addEventListener('click', ask);
    $clear.addEventListener('click', () => {
      resetChips();
      $topic.value = '';
      $out.innerHTML = '';
      $topic.focus();
    });

    // Ctrl/Cmd+Enter pour envoyer
    $topic.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        ask();
      }
    });
  })();
  </script>
</body>
</html>
